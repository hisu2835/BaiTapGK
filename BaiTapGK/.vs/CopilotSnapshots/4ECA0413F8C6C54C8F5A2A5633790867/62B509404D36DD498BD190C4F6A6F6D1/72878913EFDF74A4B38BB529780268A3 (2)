using System;
using System.Drawing;
using System.Windows.Forms;

namespace BaiTapGK
{
    /// <summary>
    /// Control hiển thị kết quả battle với layout rõ ràng
    /// </summary>
    public class BattleResultControl : UserControl
    {
        private Label lblPlayerName;
        private Label lblOpponentName;
        private HandGestureAnimationControl playerGesture;
        private HandGestureAnimationControl opponentGesture;
        private Label lblVS;
        private Label lblResult;
        private PictureBox picResultIcon;
        private bool isVisible = false;

        public BattleResultControl()
        {
            InitializeComponents();
            SetupLayout();
            this.BackColor = Color.FromArgb(240, 248, 255); // AliceBlue
            this.BorderStyle = BorderStyle.FixedSingle;
            this.Size = new Size(400, 280);
            this.Visible = false;
        }

        private void InitializeComponents()
        {
            // Player name label
            lblPlayerName = new Label
            {
                Text = "BAN",
                Font = new Font("Microsoft Sans Serif", 12, FontStyle.Bold),
                ForeColor = Color.DarkBlue,
                TextAlign = ContentAlignment.MiddleCenter,
                Size = new Size(100, 25),
                Location = new Point(50, 20)
            };

            // Opponent name label  
            lblOpponentName = new Label
            {
                Text = "DOI THU",
                Font = new Font("Microsoft Sans Serif", 12, FontStyle.Bold),
                ForeColor = Color.DarkRed,
                TextAlign = ContentAlignment.MiddleCenter,
                Size = new Size(100, 25),
                Location = new Point(250, 20)
            };

            // VS label
            lblVS = new Label
            {
                Text = "VS",
                Font = new Font("Microsoft Sans Serif", 16, FontStyle.Bold),
                ForeColor = Color.Purple,
                TextAlign = ContentAlignment.MiddleCenter,
                Size = new Size(40, 30),
                Location = new Point(180, 100)
            };

            // Player gesture
            playerGesture = new HandGestureAnimationControl
            {
                Size = new Size(80, 80),
                Location = new Point(60, 60)
            };

            // Opponent gesture
            opponentGesture = new HandGestureAnimationControl
            {
                Size = new Size(80, 80),
                Location = new Point(260, 60)
            };

            // Result label
            lblResult = new Label
            {
                Text = "",
                Font = new Font("Microsoft Sans Serif", 20, FontStyle.Bold),
                TextAlign = ContentAlignment.MiddleCenter,
                Size = new Size(380, 40),
                Location = new Point(10, 160)
            };

            // Result icon
            picResultIcon = new PictureBox
            {
                Size = new Size(60, 60),
                Location = new Point(170, 200),
                SizeMode = PictureBoxSizeMode.CenterImage
            };
        }

        private void SetupLayout()
        {
            this.Controls.AddRange(new Control[] {
                lblPlayerName,
                lblOpponentName,
                playerGesture,
                opponentGesture,
                lblVS,
                lblResult,
                picResultIcon
            });

            // Bring important elements to front
            lblResult.BringToFront();
            lblVS.BringToFront();
        }

        /// <summary>
        /// Hiển thị kết quả battle với animation
        /// </summary>
        public void ShowBattleResult(string playerChoice, string opponentChoice, string result, string playerName = "BAN", string opponentName = "DOI THU")
        {
            // Update names
            lblPlayerName.Text = playerName.ToUpper();
            lblOpponentName.Text = opponentName.ToUpper();

            // Show the control
            this.Visible = true;
            isVisible = true;
            this.BringToFront();

            // Start sequence animation
            StartBattleSequence(playerChoice, opponentChoice, result);
        }

        private void StartBattleSequence(string playerChoice, string opponentChoice, string result)
        {
            // Phase 1: Show gestures simultaneously
            playerGesture.StartShakeAnimation(playerChoice, (_) => {
                // After player animation completes
            });

            // Small delay for opponent
            System.Windows.Forms.Timer delayTimer = new System.Windows.Forms.Timer();
            delayTimer.Interval = 300;
            delayTimer.Tick += (sender, e) =>
            {
                opponentGesture.StartShakeAnimation(opponentChoice, (_) => {
                    // After both animations complete, show result
                    ShowFinalResult(result);
                });
                delayTimer.Stop();
                delayTimer.Dispose();
            };
            delayTimer.Start();
        }

        private void ShowFinalResult(string result)
        {
            // Determine result styling
            Color resultColor;
            string resultText;
            string iconText = "";

            if (result.Contains("thang"))
            {
                resultColor = Color.Green;
                resultText = "🎉 BẠN THẮNG! 🎉";
                iconText = "🏆";
                this.BackColor = Color.FromArgb(240, 255, 240); // Light green
            }
            else if (result.Contains("thua"))
            {
                resultColor = Color.Red;
                resultText = "😢 BẠN THUA! 😢";
                iconText = "💔";
                this.BackColor = Color.FromArgb(255, 240, 240); // Light red
            }
            else
            {
                resultColor = Color.Orange;
                resultText = "🤝 HÒA! 🤝";
                iconText = "🤝";
                this.BackColor = Color.FromArgb(255, 248, 240); // Light orange
            }

            // Animate result appearance
            AnimateResultDisplay(resultText, resultColor, iconText);
        }

        private void AnimateResultDisplay(string resultText, Color resultColor, string iconText)
        {
            lblResult.Text = resultText;
            lblResult.ForeColor = resultColor;

            // Create icon label instead of PictureBox for emoji
            Label iconLabel = new Label
            {
                Text = iconText,
                Font = new Font("Segoe UI Emoji", 32, FontStyle.Regular),
                Size = new Size(60, 60),
                Location = new Point(170, 200),
                TextAlign = ContentAlignment.MiddleCenter,
                BackColor = Color.Transparent
            };

            this.Controls.Remove(picResultIcon);
            this.Controls.Add(iconLabel);
            iconLabel.BringToFront();

            // Scale animation for result
            System.Windows.Forms.Timer scaleTimer = new System.Windows.Forms.Timer();
            scaleTimer.Interval = 50;
            int scaleStep = 0;
            Font originalFont = lblResult.Font;

            scaleTimer.Tick += (sender, e) =>
            {
                scaleStep++;

                if (scaleStep <= 10)
                {
                    // Scale up
                    float newSize = originalFont.Size + (scaleStep * 2);
                    lblResult.Font = new Font(originalFont.FontFamily, Math.Min(newSize, 32), originalFont.Style);
                }
                else if (scaleStep <= 15)
                {
                    // Scale back down
                    float newSize = 32 - ((scaleStep - 10) * 2);
                    lblResult.Font = new Font(originalFont.FontFamily, Math.Max(newSize, 20), originalFont.Style);
                }
                else
                {
                    // Final size
                    lblResult.Font = new Font(originalFont.FontFamily, 20, originalFont.Style);
                    scaleTimer.Stop();
                    scaleTimer.Dispose();

                    // Start auto-hide timer
                    StartAutoHideTimer();
                }
            };

            scaleTimer.Start();

            // Play appropriate sound
            if (resultText.Contains("THẮNG"))
            {
                SoundEffectHelper.PlayWinSound();
            }
            else if (resultText.Contains("THUA"))
            {
                SoundEffectHelper.PlayLoseSound();
            }
        }

        private void StartAutoHideTimer()
        {
            System.Windows.Forms.Timer hideTimer = new System.Windows.Forms.Timer();
            hideTimer.Interval = 3000; // 3 seconds
            hideTimer.Tick += (sender, e) =>
            {
                HideBattleResult();
                hideTimer.Stop();
                hideTimer.Dispose();
            };
            hideTimer.Start();
        }

        /// <summary>
        /// Ẩn kết quả battle với fade animation
        /// </summary>
        public void HideBattleResult()
        {
            if (!isVisible) return;

            // Fade out animation
            System.Windows.Forms.Timer fadeTimer = new System.Windows.Forms.Timer();
            fadeTimer.Interval = 50;
            int fadeStep = 0;

            fadeTimer.Tick += (sender, e) =>
            {
                fadeStep++;
                double alpha = Math.Max(0, 1.0 - (fadeStep * 0.1));
                
                // Can't change control alpha directly, so we'll just hide it
                if (fadeStep >= 10)
                {
                    this.Visible = false;
                    isVisible = false;
                    fadeTimer.Stop();
                    fadeTimer.Dispose();

                    // Reset to default state
                    ResetToDefault();
                }
            };
            fadeTimer.Start();
        }

        private void ResetToDefault()
        {
            lblResult.Text = "";
            lblPlayerName.Text = "BAN";
            lblOpponentName.Text = "DOI THU";
            this.BackColor = Color.FromArgb(240, 248, 255);
            
            playerGesture.Reset();
            opponentGesture.Reset();
        }

        /// <summary>
        /// Cập nhật vị trí control để center trên parent
        /// </summary>
        public void CenterOnParent()
        {
            if (this.Parent != null)
            {
                this.Location = new Point(
                    (this.Parent.Width - this.Width) / 2,
                    (this.Parent.Height - this.Height) / 2
                );
            }
        }

        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                playerGesture?.Dispose();
                opponentGesture?.Dispose();
            }
            base.Dispose(disposing);
        }
    }
}