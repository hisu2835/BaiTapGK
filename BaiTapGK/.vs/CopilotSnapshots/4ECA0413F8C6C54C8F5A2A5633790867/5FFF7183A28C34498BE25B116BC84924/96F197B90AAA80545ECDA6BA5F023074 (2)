using System;
using System.Drawing;
using System.Windows.Forms;
using System.Net;
using System.Net.Sockets;
using System.Text;
using System.Threading;
using System.Diagnostics;
using System.IO;

namespace BaiTapGK
{
    public partial class MultiPlayerForm : FullscreenSupportForm
    {
        private string playerName;
        private bool isHost = false;
        private TcpListener? tcpListener;
        private TcpClient? tcpClient;
        private NetworkStream? stream;
        private Thread? tcpListenerThread;
        private Thread? tcpClientThread;
        private string roomId;
        private bool gameStarted = false;
        private string playerChoice = "";
        private string opponentChoice = "";
        private int playerScore = 0;
        private int opponentScore = 0;
        private HandGestureAnimationControl? playerGestureControl;
        private HandGestureAnimationControl? opponentGestureControl;
        private BattleResultControl? battleResultControl;

        public MultiPlayerForm(string playerName)
        {
            InitializeComponent();
            this.playerName = playerName;
            lblPlayerName.Text = $"Nguoi choi: {playerName}";
            this.StartPosition = FormStartPosition.CenterScreen;
            this.FormBorderStyle = FormBorderStyle.Sizable; // Cho phep resize
            this.MaximizeBox = true; // Cho phep maximize
            this.MinimizeBox = true;
            
            // Set minimum size
            this.MinimumSize = new Size(540, 600);
            
            // Tao Room ID ngau nhien
            roomId = GenerateRoomId();
            txtRoomId.Text = roomId;
            
            EnableGameButtons(false);
            
            // Hien thi thong tin IP local
            ShowLocalIPInfo();
            
            // Thiet lap hover effects cho cac button
            SetupButtonEffects();
        }

        private void SetupButtonEffects()
        {
            // Thiet lap hover effects
            ButtonAnimationHelper.SetupButtonHoverEffects(btnRock);
            ButtonAnimationHelper.SetupButtonHoverEffects(btnPaper);
            ButtonAnimationHelper.SetupButtonHoverEffects(btnScissors);
            
            // Thiet lap mau sac ban dau
            btnRock.BackColor = GameConfig.ROCK_COLOR;
            btnPaper.BackColor = GameConfig.PAPER_COLOR;
            btnScissors.BackColor = GameConfig.SCISSORS_COLOR;
            
            // Thiet lap gesture controls
            SetupGestureControls();
        }

        private void SetupGestureControls()
        {
            // Player gesture control
            playerGestureControl = new HandGestureAnimationControl();
            playerGestureControl.Location = new Point(50, 360);
            playerGestureControl.Size = new Size(100, 100);
            this.Controls.Add(playerGestureControl);

            // Opponent gesture control  
            opponentGestureControl = new HandGestureAnimationControl();
            opponentGestureControl.Location = new Point(370, 360);
            opponentGestureControl.Size = new Size(100, 100);
            this.Controls.Add(opponentGestureControl);

            // Battle result control
            battleResultControl = new BattleResultControl();
            this.Controls.Add(battleResultControl);
            battleResultControl.CenterOnParent();

            // Bring gesture controls to front
            playerGestureControl.BringToFront();
            opponentGestureControl.BringToFront();
            
            // Battle result should be on top of everything
            battleResultControl.BringToFront();
        }

        protected override void AdjustLayoutForFullscreen(bool isFullscreen)
        {
            // Dieu chinh layout khi fullscreen cho multiplayer
            if (isFullscreen)
            {
                AdjustMultiplayerLayoutForFullscreen(true);
            }
            else
            {
                AdjustMultiplayerLayoutForFullscreen(false);
            }
        }

        private void AdjustMultiplayerLayoutForFullscreen(bool isFullscreen)
        {
            if (isFullscreen)
            {
                ApplyFullscreenMultiplayerLayout();
            }
            else
            {
                RestoreWindowedMultiplayerLayout();
            }
        }

        private void ApplyFullscreenMultiplayerLayout()
        {
            SuspendLayout();

            // Calculate optimal scale factor
            float baseWidth = 540f;
            float baseHeight = 600f;
            
            float widthScale = this.ClientSize.Width / baseWidth;
            float heightScale = this.ClientSize.Height / baseHeight;
            
            float scaleFactor = Math.Min(widthScale, heightScale) * 0.75f; // More conservative scaling
            scaleFactor = Math.Max(scaleFactor, 1.2f);
            scaleFactor = Math.Min(scaleFactor, 2.0f);

            int centerX = this.ClientSize.Width / 2;
            int topMargin = (int)(30 * scaleFactor);

            // Top section - player info and connection status
            if (lblPlayerName != null)
            {
                lblPlayerName.Font = new Font(lblPlayerName.Font.FontFamily, lblPlayerName.Font.Size * scaleFactor, FontStyle.Bold);
                lblPlayerName.AutoSize = true;
                lblPlayerName.Location = new Point(centerX - lblPlayerName.PreferredSize.Width / 2, topMargin);
            }

            if (lblStatus != null)
            {
                lblStatus.Font = new Font(lblStatus.Font.FontFamily, lblStatus.Font.Size * scaleFactor);
                lblStatus.AutoSize = true;
                lblStatus.Location = new Point(centerX - lblStatus.PreferredSize.Width / 2, topMargin + (int)(35 * scaleFactor));
            }

            // Network controls section - centered layout
            int networkY = topMargin + (int)(80 * scaleFactor);
            int controlWidth = (int)(150 * scaleFactor);
            int controlHeight = (int)(30 * scaleFactor);
            int controlSpacing = (int)(20 * scaleFactor);

            // Arrange network controls in a more organized manner
            var networkControls = new[]
            {
                new { Control = txtServerIP as Control, Label = "Server IP:" },
                new { Control = txtPort as Control, Label = "Port:" },
                new { Control = txtRoomId as Control, Label = "Room ID:" }
            };

            int networkStartX = centerX - (controlWidth * 3 + controlSpacing * 2) / 2;
            
            for (int i = 0; i < networkControls.Length; i++)
            {
                if (networkControls[i].Control != null)
                {
                    networkControls[i].Control.Size = new Size(controlWidth, controlHeight);
                    networkControls[i].Control.Location = new Point(
                        networkStartX + (i * (controlWidth + controlSpacing)),
                        networkY
                    );
                    
                    if (networkControls[i].Control is TextBox textBox)
                    {
                        textBox.Font = new Font(textBox.Font.FontFamily, Math.Max(textBox.Font.Size * scaleFactor, 9));
                    }
                }
            }

            // Network buttons - centered below text boxes
            var networkButtons = new[] { btnCreateRoom, btnJoinRoom };
            var validNetworkButtons = networkButtons.Where(b => b != null).ToArray();
            
            if (validNetworkButtons.Length > 0)
            {
                int networkButtonWidth = (int)(140 * scaleFactor);
                int networkButtonHeight = (int)(40 * scaleFactor);
                int networkButtonSpacing = (int)(30 * scaleFactor);
                int totalNetworkButtonWidth = (validNetworkButtons.Length * networkButtonWidth) + ((validNetworkButtons.Length - 1) * networkButtonSpacing);
                int networkButtonStartX = centerX - totalNetworkButtonWidth / 2;
                int networkButtonY = networkY + controlHeight + (int)(20 * scaleFactor);

                for (int i = 0; i < validNetworkButtons.Length; i++)
                {
                    var button = validNetworkButtons[i];
                    button.Size = new Size(networkButtonWidth, networkButtonHeight);
                    button.Location = new Point(
                        networkButtonStartX + (i * (networkButtonWidth + networkButtonSpacing)),
                        networkButtonY
                    );
                    button.Font = new Font(button.Font.FontFamily, Math.Max(button.Font.Size * scaleFactor, 9));
                }
            }

            // Game buttons section - centered horizontally
            int gameButtonY = networkY + (int)(140 * scaleFactor);
            var gameButtons = new[] { btnRock, btnPaper, btnScissors };
            var validGameButtons = gameButtons.Where(b => b != null).ToArray();
            
            if (validGameButtons.Length > 0)
            {
                int gameButtonSize = (int)(70 * scaleFactor);
                int gameButtonSpacing = (int)(40 * scaleFactor);
                int totalGameButtonWidth = (validGameButtons.Length * gameButtonSize) + ((validGameButtons.Length - 1) * gameButtonSpacing);
                int gameButtonStartX = centerX - totalGameButtonWidth / 2;

                for (int i = 0; i < validGameButtons.Length; i++)
                {
                    var button = validGameButtons[i];
                    button.Size = new Size(gameButtonSize, gameButtonSize);
                    button.Location = new Point(
                        gameButtonStartX + (i * (gameButtonSize + gameButtonSpacing)),
                        gameButtonY
                    );
                    button.Font = new Font(button.Font.FontFamily, Math.Max(button.Font.Size * scaleFactor, 9));
                }
            }

            // Gesture controls - symmetric positioning
            int gestureY = gameButtonY + (int)(100 * scaleFactor);
            int gestureSize = (int)(120 * scaleFactor);
            int gestureSpacing = this.ClientSize.Width / 4;

            if (playerGestureControl != null)
            {
                playerGestureControl.Size = new Size(gestureSize, gestureSize);
                playerGestureControl.Location = new Point(
                    gestureSpacing - gestureSize / 2,
                    gestureY
                );
            }

            if (opponentGestureControl != null)
            {
                opponentGestureControl.Size = new Size(gestureSize, gestureSize);
                opponentGestureControl.Location = new Point(
                    this.ClientSize.Width - gestureSpacing - gestureSize / 2,
                    gestureY
                );
            }

            // Player choice labels
            int choiceLabelY = gestureY + gestureSize + (int)(15 * scaleFactor);
            
            if (lblPlayerChoice != null)
            {
                lblPlayerChoice.Font = new Font(lblPlayerChoice.Font.FontFamily, lblPlayerChoice.Font.Size * scaleFactor);
                lblPlayerChoice.AutoSize = true;
                lblPlayerChoice.Location = new Point(
                    gestureSpacing - lblPlayerChoice.PreferredSize.Width / 2,
                    choiceLabelY
                );
            }

            if (lblOpponentChoice != null)
            {
                lblOpponentChoice.Font = new Font(lblOpponentChoice.Font.FontFamily, lblOpponentChoice.Font.Size * scaleFactor);
                lblOpponentChoice.AutoSize = true;
                lblOpponentChoice.Location = new Point(
                    this.ClientSize.Width - gestureSpacing - lblOpponentChoice.PreferredSize.Width / 2,
                    choiceLabelY
                );
            }

            // Game result and score - centered
            if (lblGameResult != null)
            {
                lblGameResult.Font = new Font(lblGameResult.Font.FontFamily, lblGameResult.Font.Size * scaleFactor, FontStyle.Bold);
                lblGameResult.AutoSize = true;
                lblGameResult.Location = new Point(
                    centerX - lblGameResult.PreferredSize.Width / 2,
                    choiceLabelY + (int)(40 * scaleFactor)
                );
            }

            if (lblScore != null)
            {
                lblScore.Font = new Font(lblScore.Font.FontFamily, lblScore.Font.Size * scaleFactor, FontStyle.Bold);
                lblScore.AutoSize = true;
                lblScore.Location = new Point(
                    centerX - lblScore.PreferredSize.Width / 2,
                    choiceLabelY + (int)(70 * scaleFactor)
                );
            }

            // Control buttons at bottom
            var controlButtons = new[] { btnBack };
            if (controlButtons[0] != null)
            {
                int controlButtonWidth = (int)(120 * scaleFactor);
                int controlButtonHeight = (int)(40 * scaleFactor);
                controlButtons[0].Size = new Size(controlButtonWidth, controlButtonHeight);
                controlButtons[0].Location = new Point(
                    centerX - controlButtonWidth / 2,
                    this.ClientSize.Height - (int)(60 * scaleFactor)
                );
                controlButtons[0].Font = new Font(controlButtons[0].Font.FontFamily, Math.Max(controlButtons[0].Font.Size * scaleFactor, 9));
            }

            // Wireshark buttons - position near network controls
            var wiresharkButtons = new[] { btnOpenWireshark, btnWiresharkHelp };
            var validWiresharkButtons = wiresharkButtons.Where(b => b != null).ToArray();
            
            if (validWiresharkButtons.Length > 0)
            {
                int wiresharkButtonWidth = (int)(100 * scaleFactor);
                int wiresharkButtonHeight = (int)(30 * scaleFactor);
                int wiresharkButtonSpacing = (int)(15 * scaleFactor);
                int totalWiresharkWidth = (validWiresharkButtons.Length * wiresharkButtonWidth) + ((validWiresharkButtons.Length - 1) * wiresharkButtonSpacing);
                int wiresharkStartX = centerX - totalWiresharkWidth / 2;
                int wiresharkY = networkY + controlHeight + (int)(70 * scaleFactor);

                for (int i = 0; i < validWiresharkButtons.Length; i++)
                {
                    var button = validWiresharkButtons[i];
                    button.Size = new Size(wiresharkButtonWidth, wiresharkButtonHeight);
                    button.Location = new Point(
                        wiresharkStartX + (i * (wiresharkButtonWidth + wiresharkButtonSpacing)),
                        wiresharkY
                    );
                    button.Font = new Font(button.Font.FontFamily, Math.Max(button.Font.Size * scaleFactor, 8));
                }
            }

            // Scale battle result control
            if (battleResultControl != null)
            {
                battleResultControl.ScaleForFullscreen(scaleFactor);
            }

            ResumeLayout(true);
        }

        private void RestoreWindowedMultiplayerLayout()
        {
            SuspendLayout();

            // Restore approximate original positions
            if (lblPlayerName != null)
            {
                lblPlayerName.Font = new Font(lblPlayerName.Font.FontFamily, 10, FontStyle.Bold);
                lblPlayerName.Location = new Point(20, 20);
            }

            if (lblStatus != null)
            {
                lblStatus.Font = new Font(lblStatus.Font.FontFamily, 9);
                lblStatus.Location = new Point(20, 50);
            }

            // Restore network controls
            if (txtServerIP != null)
            {
                txtServerIP.Size = new Size(120, 25);
                txtServerIP.Location = new Point(20, 80);
                txtServerIP.Font = new Font(txtServerIP.Font.FontFamily, 9);
            }

            if (txtPort != null)
            {
                txtPort.Size = new Size(80, 25);
                txtPort.Location = new Point(160, 80);
                txtPort.Font = new Font(txtPort.Font.FontFamily, 9);
            }

            if (txtRoomId != null)
            {
                txtRoomId.Size = new Size(100, 25);
                txtRoomId.Location = new Point(260, 80);
                txtRoomId.Font = new Font(txtRoomId.Font.FontFamily, 9);
            }

            // Restore network buttons
            if (btnCreateRoom != null)
            {
                btnCreateRoom.Size = new Size(100, 30);
                btnCreateRoom.Location = new Point(20, 120);
                btnCreateRoom.Font = new Font(btnCreateRoom.Font.FontFamily, 9);
            }

            if (btnJoinRoom != null)
            {
                btnJoinRoom.Size = new Size(100, 30);
                btnJoinRoom.Location = new Point(140, 120);
                btnJoinRoom.Font = new Font(btnJoinRoom.Font.FontFamily, 9);
            }

            // Restore game buttons
            var gameButtons = new[] { btnRock, btnPaper, btnScissors };
            int[] buttonXPositions = { 50, 180, 310 };
            
            for (int i = 0; i < gameButtons.Length && i < buttonXPositions.Length; i++)
            {
                if (gameButtons[i] != null)
                {
                    gameButtons[i].Size = new Size(70, 70);
                    gameButtons[i].Location = new Point(buttonXPositions[i], 180);
                    gameButtons[i].Font = new Font(gameButtons[i].Font.FontFamily, 9);
                }
            }

            // Restore gesture controls
            if (playerGestureControl != null)
            {
                playerGestureControl.Size = new Size(100, 100);
                playerGestureControl.Location = new Point(50, 360);
            }

            if (opponentGestureControl != null)
            {
                opponentGestureControl.Size = new Size(100, 100);
                opponentGestureControl.Location = new Point(370, 360);
            }

            // Restore labels
            if (lblPlayerChoice != null)
            {
                lblPlayerChoice.Font = new Font(lblPlayerChoice.Font.FontFamily, 9);
                lblPlayerChoice.Location = new Point(50, 470);
            }

            if (lblOpponentChoice != null)
            {
                lblOpponentChoice.Font = new Font(lblOpponentChoice.Font.FontFamily, 9);
                lblOpponentChoice.Location = new Point(370, 470);
            }

            if (lblGameResult != null)
            {
                lblGameResult.Font = new Font(lblGameResult.Font.FontFamily, 11, FontStyle.Bold);
                lblGameResult.Location = new Point(200, 500);
            }

            if (lblScore != null)
            {
                lblScore.Font = new Font(lblScore.Font.FontFamily, 10, FontStyle.Bold);
                lblScore.Location = new Point(150, 530);
            }

            if (btnBack != null)
            {
                btnBack.Size = new Size(100, 35);
                btnBack.Location = new Point(220, 560);
                btnBack.Font = new Font(btnBack.Font.FontFamily, 9);
            }

            // Restore Wireshark buttons
            if (btnOpenWireshark != null)
            {
                btnOpenWireshark.Size = new Size(80, 25);
                btnOpenWireshark.Location = new Point(270, 120);
                btnOpenWireshark.Font = new Font(btnOpenWireshark.Font.FontFamily, 8);
            }

            if (btnWiresharkHelp != null)
            {
                btnWiresharkHelp.Size = new Size(80, 25);
                btnWiresharkHelp.Location = new Point(360, 120);
                btnWiresharkHelp.Font = new Font(btnWiresharkHelp.Font.FontFamily, 8);
            }

            // Restore battle result control
            if (battleResultControl != null)
            {
                battleResultControl.ScaleForFullscreen(1.0f);
            }

            ResumeLayout(true);
        }

        private void AdjustGestureControlsForFullscreen(float scaleFactor)
        {
            if (playerGestureControl != null)
            {
                playerGestureControl.Size = new Size(
                    (int)(100 * scaleFactor),
                    (int)(100 * scaleFactor)
                );
                
                if (scaleFactor > 1.0f)
                {
                    playerGestureControl.Location = new Point(
                        (int)(this.ClientSize.Width * 0.25f - playerGestureControl.Width / 2),
                        (int)(this.ClientSize.Height * 0.75f)
                    );
                }
                else
                {
                    playerGestureControl.Location = new Point(50, 360);
                }
            }

            if (opponentGestureControl != null)
            {
                opponentGestureControl.Size = new Size(
                    (int)(100 * scaleFactor),
                    (int)(100 * scaleFactor)
                );
                
                if (scaleFactor > 1.0f)
                {
                    opponentGestureControl.Location = new Point(
                        (int)(this.ClientSize.Width * 0.75f - opponentGestureControl.Width / 2),
                        (int)(this.ClientSize.Height * 0.75f)
                    );
                }
                else
                {
                    opponentGestureControl.Location = new Point(370, 360);
                }
            }
        }

        private void AdjustGameButtonsForFullscreen(float scaleFactor)
        {
            AdjustButtonForFullscreen(btnRock, scaleFactor);
            AdjustButtonForFullscreen(btnPaper, scaleFactor);
            AdjustButtonForFullscreen(btnScissors, scaleFactor);
            AdjustButtonForFullscreen(btnBack, scaleFactor);
        }

        private void AdjustNetworkControlsForFullscreen(float scaleFactor)
        {
            AdjustButtonForFullscreen(btnCreateRoom, scaleFactor);
            AdjustButtonForFullscreen(btnJoinRoom, scaleFactor);
            AdjustButtonForFullscreen(btnOpenWireshark, scaleFactor);
            AdjustButtonForFullscreen(btnWiresharkHelp, scaleFactor);
            
            // Adjust text boxes if needed
            if (scaleFactor > 1.0f)
            {
                AdjustTextBoxForFullscreen(txtServerIP, scaleFactor);
                AdjustTextBoxForFullscreen(txtPort, scaleFactor);
                AdjustTextBoxForFullscreen(txtRoomId, scaleFactor);
            }
        }

        private void AdjustButtonForFullscreen(Button? button, float scaleFactor)
        {
            if (button == null) return;
            
            // Store original size in Tag if not already stored
            if (button.Tag == null)
            {
                button.Tag = new Size(button.Width, button.Height);
            }
            
            Size originalSize = (Size)button.Tag;
            button.Size = new Size(
                (int)(originalSize.Width * scaleFactor),
                (int)(originalSize.Height * scaleFactor)
            );
            
            // Adjust font
            float fontSize = button.Font.Size * scaleFactor;
            button.Font = new Font(button.Font.FontFamily, fontSize, button.Font.Style);
        }

        private void AdjustTextBoxForFullscreen(TextBox? textBox, float scaleFactor)
        {
            if (textBox == null) return;
            
            // Store original size in Tag if not already stored
            if (textBox.Tag == null)
            {
                textBox.Tag = new Size(textBox.Width, textBox.Height);
            }
            
            Size originalSize = (Size)textBox.Tag;
            textBox.Size = new Size(
                (int)(originalSize.Width * scaleFactor),
                (int)(originalSize.Height * scaleFactor)
            );
            
            // Adjust font
            float fontSize = textBox.Font.Size * scaleFactor;
            textBox.Font = new Font(textBox.Font.FontFamily, fontSize, textBox.Font.Style);
        }

        private void ShowLocalIPInfo()
        {
            try
            {
                string localIP = NetworkUtils.GetLocalIPAddress();
                lblConnectionInfo.Text = $"IP Local: {localIP} | Room: {roomId}";
            }
            catch
            {
                lblConnectionInfo.Text = $"Room: {roomId}";
            }
        }

        private string GenerateRoomId()
        {
            return NetworkUtils.GenerateRoomId();
        }

        private void btnCreateRoom_Click(object sender, EventArgs e)
        {
            try
            {
                int port = int.Parse(txtPort.Text);
                
                if (!NetworkUtils.IsPortAvailable(port))
                {
                    MessageBox.Show($"Port {port} dang duoc su dung!", "Loi", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                isHost = true;
                tcpListener = new TcpListener(IPAddress.Any, port);
                tcpListener.Start();
                
                tcpListenerThread = new Thread(new ThreadStart(ListenForClients));
                tcpListenerThread.IsBackground = true;
                tcpListenerThread.Start();
                
                lblStatus.Text = $"Dang cho nguoi choi ket noi den {NetworkUtils.GetLocalIPAddress()}:{port}";
                lblStatus.ForeColor = Color.Orange;
                btnCreateRoom.Enabled = false;
                btnJoinRoom.Enabled = false;
                
                // Hien thi thong tin cho ban be
                ShowConnectionInfo(port);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Loi khi tao phong: {ex.Message}", "Loi", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void ShowConnectionInfo(int port)
        {
            string localIP = NetworkUtils.GetLocalIPAddress();
            string message = $"THONG TIN KET NOI:\n\n" +
                           $"Server IP: {localIP}\n" +
                           $"Port: {port}\n" +
                           $"Room ID: {roomId}\n\n" +
                           $"Gui thong tin nay cho ban be de ho ket noi!\n\n" +
                           $"Su dung Wireshark de monitor traffic:\n" +
                           $"Filter: tcp port {port}";
            
            MessageBox.Show(message, "Thong tin Server", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        private void btnJoinRoom_Click(object sender, EventArgs e)
        {
            string serverIP = txtServerIP.Text.Trim();
            string portText = txtPort.Text.Trim();
            string inputRoomId = txtRoomId.Text.Trim();
            
            if (string.IsNullOrEmpty(serverIP) || string.IsNullOrEmpty(portText))
            {
                MessageBox.Show("Vui long nhap day du thong tin server!", "Thong bao", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            if (!int.TryParse(portText, out int port))
            {
                MessageBox.Show("Port khong hop le!", "Loi", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            try
            {
                isHost = false;
                tcpClient = new TcpClient();
                tcpClient.Connect(serverIP, port);
                stream = tcpClient.GetStream();
                
                tcpClientThread = new Thread(new ThreadStart(ListenForData));
                tcpClientThread.IsBackground = true;
                tcpClientThread.Start();
                
                // Gui ten nguoi choi
                SendMessage($"PLAYER:{playerName}");
                
                lblStatus.Text = $"Da ket noi den {serverIP}:{port}! San sang choi.";
                lblStatus.ForeColor = Color.Green;
                btnCreateRoom.Enabled = false;
                btnJoinRoom.Enabled = false;
                EnableGameButtons(true);
                gameStarted = true;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Khong the ket noi den server {serverIP}:{port}\n\nLoi: {ex.Message}", 
                    "Loi ket noi", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void btnOpenWireshark_Click(object sender, EventArgs e)
        {
            try
            {
                string port = txtPort.Text;
                
                if (WiresharkIntegration.LaunchWireshark(port, out string errorMessage))
                {
                    MessageBox.Show($"Da mo Wireshark voi filter: tcp port {port}\n\n" +
                                   "Bat dau choi game de xem network traffic!\n\n" +
                                   "Tips:\n" +
                                   "- Right-click packet ? Follow TCP Stream\n" +
                                   "- Statistics ? Conversations", 
                                   "Wireshark Started", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
                else
                {
                    MessageBox.Show(errorMessage, "Loi Wireshark", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    WiresharkIntegration.ShowInstructions(port, txtServerIP.Text);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Loi: {ex.Message}", "Loi", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void OpenWiresharkWithFilter(string port)
        {
            try
            {
                // Thu cac duong dan Wireshark thuong gap
                string[] wiresharkPaths = {
                    @"C:\Program Files\Wireshark\Wireshark.exe",
                    @"C:\Program Files (x86)\Wireshark\Wireshark.exe",
                    "wireshark.exe" // Neu co trong PATH
                };

                string wiresharkPath = "";
                foreach (string path in wiresharkPaths)
                {
                    if (File.Exists(path) || path == "wireshark.exe")
                    {
                        wiresharkPath = path;
                        break;
                    }
                }

                if (string.IsNullOrEmpty(wiresharkPath))
                {
                    // Neu khong tim thay Wireshark, hien thi huong dan
                    ShowWiresharkInstructions(port);
                    return;
                }

                // Tao filter cho game traffic
                string filter = $"tcp port {port}";
                
                // Khoi dong Wireshark voi filter
                ProcessStartInfo startInfo = new ProcessStartInfo
                {
                    FileName = wiresharkPath,
                    Arguments = $"-k -f \"{filter}\"", // -k: start capturing, -f: filter
                    UseShellExecute = false
                };

                Process.Start(startInfo);
                
                MessageBox.Show($"Da mo Wireshark voi filter: {filter}\n\n" +
                               "Bat dau choi game de xem network traffic!", 
                               "Wireshark", MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
            catch (Exception ex)
            {
                ShowWiresharkInstructions(port);
            }
        }

        private void ShowWiresharkInstructions(string port)
        {
            string instructions = $"HUONG DAN SU DUNG WIRESHARK:\n\n" +
                                 $"1. Mo Wireshark (tai tai: https://www.wireshark.org/)\n" +
                                 $"2. Chon network interface (thuong la Ethernet hoac WiFi)\n" +
                                 $"3. Ap dung filter: tcp port {port}\n" +
                                 $"4. Nhan Start de bat dau capture\n" +
                                 $"5. Choi game de xem traffic!\n\n" +
                                 $"CAC MESSAGE GAME BAN CO THE THAY:\n" +
                                 $"- PLAYER:[ten] - Khi player tham gia\n" +
                                 $"- CHOICE:[Da/Giay/Keo] - Khi player chon\n" +
                                 $"- RESULT:[ket qua] - Ket qua tran dau\n\n" +
                                 $"IP Server: {NetworkUtils.GetLocalIPAddress()}\n" +
                                 $"Port: {port}";

            MessageBox.Show(instructions, "Huong dan Wireshark", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        private void ListenForClients()
        {
            try
            {
                while (true)
                {
                    using (TcpClient client = tcpListener.AcceptTcpClient())
                    {
                        tcpClient = client;
                        stream = client.GetStream();
                        
                        this.Invoke((MethodInvoker)delegate
                        {
                            lblStatus.Text = "Nguoi choi da tham gia! San sang choi.";
                            lblStatus.ForeColor = Color.Green;
                            EnableGameButtons(true);
                            gameStarted = true;
                        });

                        ListenForData();
                    }
                }
            }
            catch (Exception ex)
            {
                this.Invoke((MethodInvoker)delegate
                {
                    lblStatus.Text = $"Loi server: {ex.Message}";
                    lblStatus.ForeColor = Color.Red;
                });
            }
        }

        private void ListenForData()
        {
            try
            {
                byte[] buffer = new byte[4096];
                while (true)
                {
                    int bytesRead = stream.Read(buffer, 0, buffer.Length);
                    if (bytesRead == 0) break;
                    
                    string message = Encoding.UTF8.GetString(buffer, 0, bytesRead);
                    ProcessMessage(message);
                }
            }
            catch (Exception ex)
            {
                this.Invoke((MethodInvoker)delegate
                {
                    lblStatus.Text = $"Mat ket noi: {ex.Message}";
                    lblStatus.ForeColor = Color.Red;
                    EnableGameButtons(false);
                });
            }
        }

        private void ProcessMessage(string message)
        {
            this.Invoke((MethodInvoker)delegate
            {
                if (message.StartsWith("PLAYER:"))
                {
                    string opponentName = message.Substring(7);
                    lblOpponent.Text = $"Doi thu: {opponentName}";
                }
                else if (message.StartsWith("CHOICE:"))
                {
                    opponentChoice = message.Substring(7);
                    CheckGameResult();
                }
                else if (message.StartsWith("RESULT:"))
                {
                    lblGameResult.Text = message.Substring(7);
                }
            });
        }

        private void SendMessage(string message)
        {
            try
            {
                if (stream != null)
                {
                    byte[] data = Encoding.UTF8.GetBytes(message);
                    stream.Write(data, 0, data.Length);
                }
            }
            catch (Exception ex)
            {
                lblStatus.Text = $"Loi gui tin nhan: {ex.Message}";
                lblStatus.ForeColor = Color.Red;
            }
        }

        private void btnRock_Click(object sender, EventArgs e)
        {
            // Animation cho button click
            ButtonAnimationHelper.AnimateButtonClick(btnRock, () => {
                MakeChoiceWithAnimation("Da");
            });
        }

        private void btnPaper_Click(object sender, EventArgs e)
        {
            // Animation cho button click
            ButtonAnimationHelper.AnimateButtonClick(btnPaper, () => {
                MakeChoiceWithAnimation("Giay");
            });
        }

        private void btnScissors_Click(object sender, EventArgs e)
        {
            // Animation cho button click
            ButtonAnimationHelper.AnimateButtonClick(btnScissors, () => {
                MakeChoiceWithAnimation("Keo");
            });
        }

        private void MakeChoiceWithAnimation(string choice)
        {
            // Disable buttons va animate
            EnableGameButtonsWithAnimation(false);
            
            // Hien thi choice confirmation
            Button? chosenButton = GetButtonByChoice(choice);
            if (chosenButton != null)
            {
                ButtonAnimationHelper.AnimateChoiceConfirmation(chosenButton);
            }
            
            // Reset gesture controls safely
            playerGestureControl?.Reset();
            opponentGestureControl?.Reset();
            
            // Start countdown animation for multiplayer
            CountdownAnimationHelper.StartCountdown(this, () =>
            {
                // Start player gesture animation
                playerGestureControl?.StartShakeAnimation(choice, (playerChoice) =>
                {
                    lblPlayerChoice.Text = $"Ban chon: {playerChoice}";
                    
                    // Send choice to opponent after animation
                    MakeChoice(choice);
                });
            });
        }

        private void MakeChoice(string choice)
        {
            playerChoice = choice;
            lblPlayerChoice.Text = $"Ban chon: {choice}";
            SendMessage($"CHOICE:{choice}");
            
            EnableGameButtons(false);
            lblGameResult.Text = "Dang cho doi thu...";
            
            CheckGameResult();
        }

        private void CheckGameResult()
        {
            if (!string.IsNullOrEmpty(playerChoice) && !string.IsNullOrEmpty(opponentChoice))
            {
                // Start opponent gesture animation when we receive their choice
                opponentGestureControl?.StartShakeAnimation(opponentChoice, (oppChoice) =>
                {
                    lblOpponentChoice.Text = $"Doi thu chon: {oppChoice}";
                    
                    // Show final result after opponent animation
                    ShowFinalMultiplayerResult();
                });
            }
        }

        private void ShowFinalMultiplayerResult()
        {
            string result = GetGameResult(playerChoice, opponentChoice);
            
            // Get opponent name from label
            string opponentName = lblOpponent.Text.Replace("Doi thu: ", "").Trim();
            if (string.IsNullOrEmpty(opponentName) || opponentName == "---")
            {
                opponentName = "DOI THU";
            }
            
            // Show battle result with new control
            battleResultControl?.ShowBattleResult(playerChoice, opponentChoice, result, playerName, opponentName);
            
            if (result.Contains("Ban thang"))
            {
                playerScore++;
                // Win celebration is handled by BattleResultControl
            }
            else if (result.Contains("Ban thua"))
            {
                opponentScore++;
                // Lose sound is handled by BattleResultControl
            }
            
            UpdateScoreWithAnimation();
            
            // Reset cho van tiep theo sau 4 giay
            System.Windows.Forms.Timer resetTimer = new System.Windows.Forms.Timer();
            resetTimer.Interval = 4000; // Longer to see battle result
            resetTimer.Tick += (s, e) =>
            {
                ResetRoundWithAnimation();
                resetTimer.Stop();
                resetTimer.Dispose();
            };
            resetTimer.Start();
        }

        private void ShowResultWithAnimation()
        {
            // Tao hieu ung fade-in cho opponent choice
            lblOpponentChoice.ForeColor = Color.Transparent;
            
            System.Windows.Forms.Timer fadeTimer = new System.Windows.Forms.Timer();
            fadeTimer.Interval = 50;
            int fadeStep = 0;
            
            fadeTimer.Tick += (sender, e) =>
            {
                fadeStep++;
                double progress = Math.Min(fadeStep / 10.0, 1.0);
                
                int alpha = (int)(255 * progress);
                lblOpponentChoice.ForeColor = Color.FromArgb(alpha, Color.Black);
                
                if (fadeStep >= 10)
                {
                    lblOpponentChoice.ForeColor = Color.Black;
                    fadeTimer.Stop();
                    fadeTimer.Dispose();
                }
            };
            fadeTimer.Start();
        }

        private void UpdateScoreWithAnimation()
        {
            UpdateScore();
            
            // Animate score update
            System.Windows.Forms.Timer pulseTimer = new System.Windows.Forms.Timer();
            pulseTimer.Interval = 100;
            int pulseStep = 0;
            Font originalFont = lblScore.Font;
            
            pulseTimer.Tick += (sender, e) =>
            {
                pulseStep++;
                
                if (pulseStep <= 3)
                {
                    // Phong to
                    lblScore.Font = new Font(originalFont.FontFamily, originalFont.Size + 2, FontStyle.Bold);
                    lblScore.ForeColor = Color.DarkBlue;
                }
                else
                {
                    // Thu nho ve ban dau
                    lblScore.Font = originalFont;
                    lblScore.ForeColor = Color.DarkGreen;
                }
                
                if (pulseStep >= 6)
                {
                    pulseTimer.Stop();
                    pulseTimer.Dispose();
                }
            };
            pulseTimer.Start();
        }

        private void ResetRoundWithAnimation()
        {
            // Reset gesture controls safely
            playerGestureControl?.Reset();
            opponentGestureControl?.Reset();
            
            // Animate reset process
            System.Windows.Forms.Timer resetTimer = new System.Windows.Forms.Timer();
            resetTimer.Interval = 150;
            int resetStep = 0;
            
            resetTimer.Tick += (sender, e) =>
            {
                resetStep++;
                
                switch (resetStep)
                {
                    case 1:
                        playerChoice = "";
                        lblPlayerChoice.Text = "Ban chon: ---";
                        lblPlayerChoice.ForeColor = Color.Gray;
                        break;
                    case 2:
                        opponentChoice = "";
                        lblOpponentChoice.Text = "Doi thu chon: ---";
                        lblOpponentChoice.ForeColor = Color.Gray;
                        break;
                    case 3:
                        lblGameResult.Text = "Chon lua chon cua ban";
                        lblGameResult.ForeColor = Color.Black;
                        break;
                    case 4:
                        // Khoi phuc mau sac ban dau
                        lblPlayerChoice.ForeColor = Color.Black;
                        lblOpponentChoice.ForeColor = Color.Black;
                        EnableGameButtonsWithAnimation(true);
                        resetTimer.Stop();
                        resetTimer.Dispose();
                        break;
                }
            };
            resetTimer.Start();
        }

        private string GetGameResult(string player, string opponent)
        {
            if (player == opponent)
                return "Hoa!";

            if ((player == "Da" && opponent == "Keo") ||
                (player == "Giay" && opponent == "Da") ||
                (player == "Keo" && opponent == "Giay"))
            {
                return "Ban thang!";
            }
            else
            {
                return "Ban thua!";
            }
        }

        private void UpdateScore()
        {
            lblScore.Text = $"Ty so - Ban: {playerScore} | Doi thu: {opponentScore}";
        }

        private void EnableGameButtons(bool enabled)
        {
            EnableGameButtonsWithAnimation(enabled);
        }

        private void EnableGameButtonsWithAnimation(bool enabled)
        {
            btnRock.Enabled = enabled;
            btnPaper.Enabled = enabled;
            btnScissors.Enabled = enabled;
            
            if (enabled)
            {
                ButtonAnimationHelper.AnimateButtonEnable(btnRock);
                ButtonAnimationHelper.AnimateButtonEnable(btnPaper);
                ButtonAnimationHelper.AnimateButtonEnable(btnScissors);
            }
            else
            {
                ButtonAnimationHelper.AnimateButtonDisable(btnRock);
                ButtonAnimationHelper.AnimateButtonDisable(btnPaper);
                ButtonAnimationHelper.AnimateButtonDisable(btnScissors);
            }
        }

        private void btnBack_Click(object sender, EventArgs e)
        {
            // Stop animations before closing
            ButtonAnimationHelper.StopCurrentAnimation();
            
            // Stop gesture animations
            playerGestureControl?.StopAnimation();
            opponentGestureControl?.StopAnimation();
            
            // Hide battle result
            battleResultControl?.HideBattleResult();
            
            // Dong ket noi
            try
            {
                stream?.Close();
                tcpClient?.Close();
                tcpListener?.Stop();
                
                // Su dung CancellationToken thay vi Abort()
                tcpListenerThread = null;
                tcpClientThread = null;
            }
            catch { }
            
            this.Close();
        }

        protected override void OnFormClosing(FormClosingEventArgs e)
        {
            // Stop animations before closing
            ButtonAnimationHelper.StopCurrentAnimation();
            
            // Stop gesture animations
            playerGestureControl?.StopAnimation();
            opponentGestureControl?.StopAnimation();
            
            // Hide battle result
            battleResultControl?.HideBattleResult();
            
            // Dong ket noi khi dong form
            try
            {
                stream?.Close();
                tcpClient?.Close();
                tcpListener?.Stop();
                
                tcpListenerThread = null;
                tcpClientThread = null;
            }
            catch { }
            
            base.OnFormClosing(e);
        }

        private void btnWiresharkHelp_Click(object sender, EventArgs e)
        {
            try
            {
                string port = txtPort.Text;
                string serverIP = string.IsNullOrEmpty(txtServerIP.Text) ? NetworkUtils.GetLocalIPAddress() : txtServerIP.Text;
                
                // Hien thi thong tin Wireshark status
                string status = WiresharkIntegration.IsWiresharkInstalled() ? 
                    "Da cai dat" : "Chua cai dat";
                string version = WiresharkIntegration.GetWiresharkVersion();
                
                string info = $"WIRESHARK STATUS:\n" +
                             $"Trang thai: {status}\n" +
                             $"Phien ban: {version}\n\n" +
                             $"Chon hanh dong:";
                
                DialogResult result = MessageBox.Show(info + "\n\nYes = Xem huong dan\nNo = Tao filter file\nCancel = Dong",
                    "Wireshark Help", MessageBoxButtons.YesNoCancel, MessageBoxIcon.Question);
                
                switch (result)
                {
                    case DialogResult.Yes:
                        WiresharkIntegration.ShowInstructions(port, serverIP);
                        break;
                    case DialogResult.No:
                        WiresharkIntegration.CreateFilterFile(port);
                        break;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Loi: {ex.Message}", "Loi", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private Button? GetButtonByChoice(string choice)
        {
            return choice switch
            {
                "Da" => btnRock,
                "Giay" => btnPaper,
                "Keo" => btnScissors,
                _ => null
            };
        }
    }
}